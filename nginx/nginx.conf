worker_processes 1;

events { worker_connections 1024; }

http {
  sendfile on;
  upstream api { server api:8000; }
  upstream web { server web:3000; }
  upstream ai { server ai-engine:8001; }

  map $request_uri $cache_key {
    default "$request_method|$scheme://$host$request_uri";
  }

  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=card_cache:10m max_size=100m inactive=5m use_temp_path=off;

  server {
    listen 80;

    location ~* ^/public/cards/[^/]+$ {
      proxy_pass http://api;
      proxy_cache card_cache;
      proxy_cache_valid 200 60s;
      add_header X-Cache-Status $upstream_cache_status;
    }

    location ~* ^/public/cards/.+/(chat|meta)$ {
      proxy_pass http://api;
      add_header Cache-Control "no-store";
    }

    location /api/ {
      proxy_pass http://api/;
    }

    location /ai/ {
      proxy_pass http://ai/;
    }

    location / {
      proxy_pass http://web;
    }
  }
}
